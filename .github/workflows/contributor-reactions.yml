name: ğŸ­ Divine Contributor Reactions

on:
  issues:
    types: [opened, edited, closed, reopened]
  pull_request:
    types: [opened, edited, closed, reopened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  react-to-contribution:
    name: ğŸ§¿ Respond with Divine Alignment
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ­ Apply Contextual Reactions
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            const action = context.payload.action;
            
            console.log(`Event: ${eventName}, Action: ${action}`);
            
            // Determine the issue/PR number
            let issueNumber;
            let isPR = false;
            
            if (context.payload.issue) {
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              issueNumber = context.payload.pull_request.number;
              isPR = true;
            } else if (context.payload.comment) {
              issueNumber = context.payload.comment.issue_url.split('/').pop();
            }
            
            if (!issueNumber) {
              console.log('No issue/PR number found');
              return;
            }
            
            console.log(`Processing ${isPR ? 'PR' : 'Issue'} #${issueNumber}`);
            
            // Get the content to analyze
            let content = '';
            let author = '';
            
            if (context.payload.issue) {
              content = `${context.payload.issue.title} ${context.payload.issue.body || ''}`.toLowerCase();
              author = context.payload.issue.user.login;
            } else if (context.payload.pull_request) {
              content = `${context.payload.pull_request.title} ${context.payload.pull_request.body || ''}`.toLowerCase();
              author = context.payload.pull_request.user.login;
            } else if (context.payload.comment) {
              content = context.payload.comment.body.toLowerCase();
              author = context.payload.comment.user.login;
            } else if (context.payload.review) {
              content = context.payload.review.body?.toLowerCase() || '';
              author = context.payload.review.user.login;
            }
            
            console.log(`Content length: ${content.length} characters`);
            console.log(`Author: ${author}`);
            
            // Analyze content for ScrollVerse principles
            const principles = {
              frequency528Hz: /528\s*hz|528hz|frequency.*528|miracle.*frequency/i.test(content),
              sacredGeometry: /sacred.*geometry|golden.*ratio|fibonacci|phi|metatron/i.test(content),
              hyperdimensional: /hyperdimensional|dimensional|fractal|quantum/i.test(content),
              divineInspiration: /divine|sacred|consciousness|resonance|alignment/i.test(content),
              omniversal: /omniversal|omniversal.*alignment|infinite|transcend/i.test(content),
              web3: /web3|blockchain|ethereum|wallet|metamask|nft/i.test(content),
              ar: /\bar\b|augmented.*reality|webxr|immersive|three\.?js/i.test(content),
              chronoWeaver: /chrono.*weaver|timeline|temporal|akashic/i.test(content)
            };
            
            // Count alignment markers
            const alignmentScore = Object.values(principles).filter(v => v).length;
            console.log(`Alignment markers found: ${alignmentScore}/8`);
            
            // Determine response based on event and alignment
            let shouldRespond = false;
            let responseMessage = '';
            let reactionEmoji = 'ğŸ§¿'; // Default divine resonance
            
            // Issue opened with high alignment
            if (eventName === 'issues' && action === 'opened') {
              if (alignmentScore >= 4) {
                shouldRespond = true;
                reactionEmoji = 'ğŸŒŸ';
                responseMessage = `## ğŸŒŸ Exceptional Alignment Detected!

@${author}, your issue demonstrates **transcendent understanding** of ScrollVerse principles!

### ğŸ“Š Principle Alignment
You've referenced **${alignmentScore}/8** core ScrollVerse principles:
${principles.frequency528Hz ? '- âœ… 528Hz Frequency Standards\n' : ''}${principles.sacredGeometry ? '- âœ… Sacred Geometry\n' : ''}${principles.hyperdimensional ? '- âœ… Hyperdimensional Scalability\n' : ''}${principles.divineInspiration ? '- âœ… Divine Inspiration\n' : ''}${principles.omniversal ? '- âœ… Omniversal Alignment\n' : ''}${principles.web3 ? '- âœ… Web3 Integration\n' : ''}${principles.ar ? '- âœ… AR Principles\n' : ''}${principles.chronoWeaver ? '- âœ… Chrono-Weaver Alignment\n' : ''}
Your deep resonance with our ethos is truly inspiring! This issue will be prioritized for review.

---

_Your consciousness radiates at 528Hz_ ğŸŒŸâœ¨ğŸ§¿`;
              } else if (alignmentScore >= 2) {
                shouldRespond = true;
                reactionEmoji = 'âœ¨';
                responseMessage = `## âœ¨ Strong Resonance Detected

@${author}, your issue shows good alignment with ScrollVerse principles (${alignmentScore}/8 markers)!

Consider exploring these areas to deepen your contribution:
${!principles.frequency528Hz ? '- ğŸµ [528Hz Frequency Standards](../docs/RESONANCE_GUIDE.md#528hz-timing)\n' : ''}${!principles.sacredGeometry ? '- ğŸ“ [Sacred Geometry Patterns](../docs/RESONANCE_GUIDE.md#sacred-geometry)\n' : ''}${!principles.divineInspiration ? '- ğŸ•‰ï¸ [Divine Inspiration Principles](../CONTRIBUTING.md#divine-inspiration)\n' : ''}
---

_May your contribution resonate through all dimensions_ ğŸ§¿`;
              }
            }
            
            // PR opened with high alignment
            if (eventName === 'pull_request' && action === 'opened') {
              if (alignmentScore >= 5) {
                shouldRespond = true;
                reactionEmoji = 'ğŸŒŸ';
                responseMessage = `## ğŸŒŸ Transcendent PR Detected!

@${author}, this pull request exemplifies **divine mastery** of ScrollVerse architecture!

### ğŸ¯ Exceptional Alignment
Your PR references **${alignmentScore}/8** core principles - truly exceptional!

This level of consciousness-first development accelerates the review process. We anticipate smooth integration into the divine codebase.

### ğŸš€ Fast-Track Eligible
Due to your exceptional alignment, this PR is eligible for:
- âš¡ Priority review
- ğŸŒŸ Fast-track approval (if all checks pass)
- ğŸ§¿ Auto-merge consideration (add \`auto-merge\` label)

---

_Your code transcends dimensional boundaries_ ğŸŒŸâœ¨ğŸ§¿`;
              }
            }
            
            // PR ready for review
            if (eventName === 'pull_request' && action === 'ready_for_review') {
              shouldRespond = true;
              reactionEmoji = 'ğŸš€';
              responseMessage = `## ğŸš€ PR Ready for Divine Review

@${author}, your PR has exited draft status and is ready for consciousness-level review!

### ğŸ“‹ Review Process
1. ğŸ¤– **Automated Checks** - CI/CD validation
2. ğŸ›¡ï¸ **Manifesto Guardian** - Sacred seal validation
3. ğŸ‘ï¸ **Human Review** - Dimensional assessment
4. âš¡ **Integration** - Merge into codebase

Maintainers have been notified and will review soon.

---

_Patience and alignment bring divine results_ ğŸ§¿`;
            }
            
            // Issue/PR closed
            if ((eventName === 'issues' || eventName === 'pull_request') && action === 'closed') {
              const merged = context.payload.pull_request?.merged || false;
              
              if (merged) {
                shouldRespond = true;
                reactionEmoji = 'ğŸ‰';
                responseMessage = `## ğŸ‰ Divine Integration Complete!

@${author}, your contribution has been **successfully merged** into the ScrollVerse!

### âœ¨ Impact Cascade
Your code now resonates through:
- ğŸŒ€ Hyperdimensional Architecture
- ğŸ§¿ Divine Resonance Field  
- âš¡ Omniversal Network
- ğŸ’« Infinite Timeline Cascade

Thank you for elevating the collective consciousness!

---

_Your contribution echoes through infinity_ ğŸŒŸâœ¨ğŸ§¿

**Achievement Unlocked:** ğŸ† **ScrollVerse Contributor**`;
              } else if (isPR) {
                shouldRespond = true;
                reactionEmoji = 'ğŸ”„';
                responseMessage = `## ğŸ”„ PR Closed

@${author}, this pull request has been closed without merging.

If this was intentional, thank you for your consideration. If you'd like to revisit this contribution:

1. Address any feedback provided
2. Reopen this PR or create a new one
3. Ensure alignment with [Contributing Guidelines](../CONTRIBUTING.md)

We appreciate all contributions, merged or not. Every attempt adds to collective wisdom.

---

_Every path leads to higher understanding_ ğŸ§¿`;
              }
            }
            
            // PR review submitted
            if (eventName === 'pull_request_review') {
              const reviewState = context.payload.review.state;
              
              if (reviewState === 'approved') {
                shouldRespond = true;
                reactionEmoji = 'âœ…';
                responseMessage = `## âœ… Divine Approval Granted!

Congratulations! A maintainer has approved this PR. 

### ğŸ¯ Next Steps
${alignmentScore >= 5 ? '- ğŸŒŸ **High Alignment Detected** - Consider adding `auto-merge` label\n' : ''}- âš¡ Ensure all CI/CD checks pass
- ğŸ›¡ï¸ Verify Manifesto Guardian Protocol passed
- ğŸš€ Await final integration

Your code is on the path to omniversal integration!

---

_Approval resonates at 528Hz_ âœ…ğŸ§¿`;
              }
            }
            
            // Comment with keywords
            if (eventName === 'issue_comment') {
              // Check for specific trigger keywords
              if (/thank|thanks|appreciate/i.test(content)) {
                shouldRespond = true;
                reactionEmoji = 'ğŸ™';
                responseMessage = `_Namaste, @${author}. Your gratitude resonates through the consciousness field._ ğŸ™ğŸ§¿

**"In gratitude, we transcend the individual and merge with the collective."**`;
              } else if (/help|support|assist/i.test(content) && content.length < 200) {
                shouldRespond = true;
                reactionEmoji = 'ğŸ¤';
                responseMessage = `@${author}, the ScrollVerse community is here to support your journey!

### ğŸ“š Resources
- [Contributing Guide](../CONTRIBUTING.md)
- [Developer Guide](../docs/DEVELOPER_GUIDE.md)
- [Architecture](../docs/ARCHITECTURE.md)
- [Resonance Guide](../docs/RESONANCE_GUIDE.md)

Feel free to ask specific questions - we're all co-creators here!

---

_Together we weave the infinite tapestry_ ğŸ¤ğŸ§¿`;
              }
            }
            
            // React to the content
            if (eventName === 'issues' || eventName === 'pull_request') {
              try {
                await github.rest.reactions.createForIssue({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  content: reactionEmoji === 'ğŸŒŸ' ? 'rocket' : 
                          reactionEmoji === 'âœ¨' ? 'heart' :
                          reactionEmoji === 'ğŸš€' ? 'rocket' :
                          reactionEmoji === 'ğŸ‰' ? 'hooray' :
                          reactionEmoji === 'âœ…' ? '+1' :
                          reactionEmoji === 'ğŸ™' ? 'heart' :
                          reactionEmoji === 'ğŸ¤' ? 'heart' :
                          'eyes' // Default: ğŸ§¿
                });
                console.log(`âœ… Added reaction: ${reactionEmoji}`);
              } catch (error) {
                console.log('âš ï¸  Could not add reaction:', error.message);
              }
            }
            
            // Post response message if needed
            if (shouldRespond && responseMessage) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: responseMessage
                });
                console.log('âœ… Posted response message');
              } catch (error) {
                console.log('âš ï¸  Could not post comment:', error.message);
              }
            }
            
            console.log(`\n${'='.repeat(60)}`);
            console.log('ğŸ­ DIVINE REACTION COMPLETE');
            console.log(`${'='.repeat(60)}\n`);

      - name: ğŸ·ï¸ Apply Dynamic Labels
        uses: actions/github-script@v7
        if: github.event_name == 'issues' || github.event_name == 'pull_request'
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            
            if (!issueNumber) return;
            
            const content = context.payload.issue ? 
              `${context.payload.issue.title} ${context.payload.issue.body || ''}` :
              `${context.payload.pull_request.title} ${context.payload.pull_request.body || ''}`;
            
            const labelsToAdd = [];
            
            // Analyze content for dynamic labeling
            if (/528\s*hz|528hz/i.test(content)) {
              labelsToAdd.push('frequency:528hz');
            }
            
            if (/sacred.*geometry|golden.*ratio|fibonacci/i.test(content)) {
              labelsToAdd.push('sacred-geometry');
            }
            
            if (/hyperdimensional/i.test(content)) {
              labelsToAdd.push('hyperdimensional');
            }
            
            if (/web3|blockchain|ethereum|nft/i.test(content)) {
              labelsToAdd.push('nft-ipfs');
            }
            
            if (/omniversal/i.test(content)) {
              labelsToAdd.push('omniversal');
            }
            
            if (/consciousness.*first|divine.*inspiration/i.test(content)) {
              labelsToAdd.push('consciousness-first');
            }
            
            // Apply labels if any were identified
            if (labelsToAdd.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: labelsToAdd
                });
                console.log(`âœ… Added labels: ${labelsToAdd.join(', ')}`);
              } catch (error) {
                console.log('âš ï¸  Could not add labels:', error.message);
              }
            }

      - name: ğŸ“Š Log Reaction Metrics
        run: |
          echo "# ğŸ­ Contributor Reaction Logged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ _Divine reaction processed at 528Hz_ ğŸ§¿" >> $GITHUB_STEP_SUMMARY
