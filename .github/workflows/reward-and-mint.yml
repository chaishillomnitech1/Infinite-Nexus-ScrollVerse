name: Rewards & NFT Minting Pilot

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode'
        required: false
        default: 'true'

jobs:
  rewards-pilot:
    name: Contributor Rewards (Test Phase)
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Calculate contribution score
        id: score
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 0;
            const author = context.payload.pull_request?.user?.login || 'unknown';
            
            // Simple scoring algorithm (pilot phase)
            let score = 0;
            
            if (context.payload.pull_request) {
              const pr = context.payload.pull_request;
              
              // Scoring configuration (pilot phase - tune based on feedback)
              const SCORING = {
                BASE_MERGED_PR: 10,
                ADDITIONS_DIVISOR: 10,
                ADDITIONS_CAP: 20,
                DELETIONS_DIVISOR: 20,
                DELETIONS_CAP: 10,
                FILES_MULTIPLIER: 2,
                FILES_CAP: 15,
                COMMENTS_MULTIPLIER: 1,
                COMMENTS_CAP: 5
              };
              
              // Base score for merged PR
              score += SCORING.BASE_MERGED_PR;
              
              // Additions/deletions (capped to prevent gaming)
              score += Math.min(pr.additions / SCORING.ADDITIONS_DIVISOR, SCORING.ADDITIONS_CAP);
              score += Math.min(pr.deletions / SCORING.DELETIONS_DIVISOR, SCORING.DELETIONS_CAP);
              
              // Changed files (scope of changes)
              score += Math.min(pr.changed_files * SCORING.FILES_MULTIPLIER, SCORING.FILES_CAP);
              
              // Comments (engagement and collaboration)
              score += Math.min(pr.comments * SCORING.COMMENTS_MULTIPLIER, SCORING.COMMENTS_CAP);
            }
            
            score = Math.round(score);
            
            console.log(`Contribution score for ${author}: ${score}`);
            core.setOutput('score', score);
            core.setOutput('author', author);
            core.setOutput('pr_number', prNumber);
            
            return { score, author, prNumber };
            
      - name: Prepare reward transaction (Mumbai testnet)
        id: reward
        env:
          REWARDS_PRIVATE_KEY: ${{ secrets.REWARDS_PRIVATE_KEY }}
          ALCHEMY_MUMBAI_URL: ${{ secrets.ALCHEMY_MUMBAI_URL }}
          REWARDS_CONTRACT_ADDRESS: ${{ secrets.REWARDS_CONTRACT_ADDRESS }}
          PILOT_TEST_WALLET: ${{ secrets.PILOT_TEST_WALLET }}
        run: |
          echo "=== Rewards Pilot Phase - Test Mode ==="
          echo "Contributor: ${{ steps.score.outputs.author }}"
          echo "Score: ${{ steps.score.outputs.score }}"
          echo "PR: #${{ steps.score.outputs.pr_number }}"
          echo ""
          echo "Note: Actual blockchain transactions disabled in pilot phase"
          echo "Transactions will be sent to Mumbai testnet when enabled"
          echo ""
          
          # Validate environment variables are set
          if [ -z "$REWARDS_PRIVATE_KEY" ]; then
            echo "âš ï¸  REWARDS_PRIVATE_KEY not configured"
          else
            echo "âœ… REWARDS_PRIVATE_KEY configured"
          fi
          
          if [ -z "$ALCHEMY_MUMBAI_URL" ]; then
            echo "âš ï¸  ALCHEMY_MUMBAI_URL not configured"
          else
            echo "âœ… ALCHEMY_MUMBAI_URL configured"
          fi
          
          if [ -z "$REWARDS_CONTRACT_ADDRESS" ]; then
            echo "âš ï¸  REWARDS_CONTRACT_ADDRESS not configured"
          else
            echo "âœ… REWARDS_CONTRACT_ADDRESS configured"
          fi
          
          if [ -z "$PILOT_TEST_WALLET" ]; then
            echo "âš ï¸  PILOT_TEST_WALLET not configured"
          else
            echo "âœ… PILOT_TEST_WALLET configured"
          fi
          
          # Simulate reward calculation
          REWARD_AMOUNT=$((${{ steps.score.outputs.score }} * 100))
          echo "reward_amount=$REWARD_AMOUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Simulated reward: $REWARD_AMOUNT test tokens"
          
      - name: Post rewards summary
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const score = ${{ steps.score.outputs.score }};
            const rewardAmount = ${{ steps.reward.outputs.reward_amount }};
            const author = '${{ steps.score.outputs.author }}';
            
            const comment = `### ðŸŽ Contributor Rewards Summary (Pilot Phase)
            
            **Contributor:** @${author}
            **Contribution Score:** ${score} points
            **Simulated Reward:** ${rewardAmount} test tokens
            
            #### Scoring Breakdown
            - âœ… Merged PR: Base points
            - ðŸ“ Code changes: Based on additions/deletions
            - ðŸ“ Files modified: Based on scope
            - ðŸ’¬ Engagement: Based on discussion
            
            #### Next Steps for Live Rewards
            
            Once the following secrets are configured, rewards will be automatically distributed on Mumbai testnet:
            
            - \`REWARDS_PRIVATE_KEY\` - Test wallet private key
            - \`ALCHEMY_MUMBAI_URL\` - Mumbai RPC endpoint
            - \`REWARDS_CONTRACT_ADDRESS\` - Deployed contract address
            - \`REWARDS_API_KEY\` - Rewards system API key
            - \`PILOT_TEST_WALLET\` - Test recipient address
            
            **Security Notes:**
            - Only testnet (Mumbai) transactions in pilot phase
            - No mainnet keys should be used
            - All transactions logged and auditable
            - Manual approval available for high-value rewards
            
            *This is a pilot phase simulation. Actual token distribution is disabled.*
            `;
            
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
            
      - name: Rewards Summary
        run: |
          echo "### Rewards & Minting Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ **Mode:** Pilot Phase (Test)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ **Contributor:** ${{ steps.score.outputs.author }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Score:** ${{ steps.score.outputs.score }} points" >> $GITHUB_STEP_SUMMARY
          echo "ðŸª™ **Simulated Reward:** ${{ steps.reward.outputs.reward_amount }} test tokens" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Network:** Mumbai Testnet (when enabled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Configure secrets to enable live testnet transactions*" >> $GITHUB_STEP_SUMMARY
