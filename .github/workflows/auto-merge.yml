name: ðŸŒŸ ScrollVerse Sovereignty Auto-Merge

on:
  pull_request_target:
    types: [labeled, synchronize]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-merge-eligibility:
    name: âœ… Check Merge Eligibility
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'auto-merge')) ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    outputs:
      can_merge: ${{ steps.check.outputs.can_merge }}
      merge_method: ${{ steps.check.outputs.merge_method }}
      brilliance_score: ${{ steps.check.outputs.brilliance_score }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check Merge Criteria
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number || 
                               context.payload.check_suite?.pull_requests[0]?.number;
            
            if (!pull_number) {
              console.log('No PR number found, skipping');
              return;
            }
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });
            
            console.log(`Checking PR #${pull_number}: ${pr.title}`);
            
            // Initialize eligibility checks
            let canMerge = true;
            let reasons = [];
            
            // Check 1: Must have 'auto-merge' label
            const hasAutoMergeLabel = pr.labels.some(label => 
              label.name === 'auto-merge' || label.name === 'automerge'
            );
            
            if (!hasAutoMergeLabel) {
              console.log('âŒ Missing auto-merge label');
              canMerge = false;
              reasons.push('Missing auto-merge label');
            } else {
              console.log('âœ… Has auto-merge label');
            }
            
            // Check 2: Must be approved
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number
            });
            
            const approvalCount = reviews.filter(r => r.state === 'APPROVED').length;
            const hasApproval = approvalCount >= 1;
            
            if (!hasApproval) {
              console.log('âŒ No approvals found');
              canMerge = false;
              reasons.push('Requires at least 1 approval');
            } else {
              console.log(`âœ… Has ${approvalCount} approval(s)`);
            }
            
            // Check 3: All checks must pass
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: pr.head.sha,
              per_page: 100
            });
            
            const failedChecks = checkRuns.check_runs.filter(check => 
              check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );
            
            if (failedChecks.length > 0) {
              console.log(`âŒ ${failedChecks.length} check(s) failed`);
              canMerge = false;
              reasons.push(`${failedChecks.length} check(s) failed`);
            } else {
              console.log('âœ… All checks passed');
            }
            
            // Check 4: Must not be in draft
            if (pr.draft) {
              console.log('âŒ PR is in draft state');
              canMerge = false;
              reasons.push('PR is in draft state');
            } else {
              console.log('âœ… PR is not in draft');
            }
            
            // Check 5: Must be mergeable (no conflicts)
            if (pr.mergeable === false) {
              console.log('âŒ PR has merge conflicts');
              canMerge = false;
              reasons.push('PR has merge conflicts');
            } else if (pr.mergeable === true) {
              console.log('âœ… PR is mergeable');
            } else {
              console.log('â³ Mergeable status unknown, waiting...');
              canMerge = false;
              reasons.push('Mergeable status unknown');
            }
            
            // Check 6: Assess Brilliance Score from comments
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number
            });
            
            let brillianceScore = 0;
            for (const comment of comments) {
              const match = comment.body.match(/Brilliance Score:\s*(\d+)\/100/);
              if (match) {
                brillianceScore = parseInt(match[1]);
                break;
              }
            }
            
            console.log(`ðŸ“Š Brilliance Score: ${brillianceScore}/100`);
            
            // Check 7: Brilliance threshold for auto-merge
            const minBrillianceScore = 60; // Requires HARMONIC or higher
            if (brillianceScore > 0 && brillianceScore < minBrillianceScore) {
              console.log(`âŒ Brilliance score ${brillianceScore} below threshold ${minBrillianceScore}`);
              canMerge = false;
              reasons.push(`Brilliance score ${brillianceScore} below threshold ${minBrillianceScore}`);
            } else if (brillianceScore >= minBrillianceScore) {
              console.log(`âœ… Brilliance score ${brillianceScore} meets threshold`);
            }
            
            // Check 8: Required labels for sovereignty workflow
            const hasDivineResonance = pr.labels.some(label => label.name === 'divine-resonance');
            
            if (!hasDivineResonance) {
              console.log('âš ï¸  Missing divine-resonance label (recommended but not required)');
            }
            
            // Determine merge method based on labels
            let mergeMethod = 'squash'; // Default
            if (pr.labels.some(label => label.name === 'merge-commit')) {
              mergeMethod = 'merge';
            } else if (pr.labels.some(label => label.name === 'rebase')) {
              mergeMethod = 'rebase';
            }
            
            console.log(`\n${'='.repeat(60)}`);
            console.log(`Can Merge: ${canMerge ? 'âœ… YES' : 'âŒ NO'}`);
            if (!canMerge) {
              console.log(`Reasons: ${reasons.join(', ')}`);
            }
            console.log(`Merge Method: ${mergeMethod}`);
            console.log(`${'='.repeat(60)}\n`);
            
            core.setOutput('can_merge', canMerge ? 'true' : 'false');
            core.setOutput('merge_method', mergeMethod);
            core.setOutput('brilliance_score', brillianceScore.toString());
            
            // Post status comment if not eligible
            if (!canMerge) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "## ðŸ”„ Auto-Merge Status: Not Ready\n\n" +
                  "```\n" +
                  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n" +
                  "â•‘          AUTO-MERGE ELIGIBILITY CHECK: NOT READY                 â•‘\n" +
                  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
                  "```\n\n" +
                  "### âŒ Requirements Not Met\n\n" +
                  reasons.map(r => "- " + r).join('\n') + "\n\n" +
                  "### ðŸ“‹ Auto-Merge Requirements\n\n" +
                  "To enable auto-merge, ensure:\n\n" +
                  "1. âœ… PR has `auto-merge` label\n" +
                  "2. âœ… At least 1 approval from maintainer\n" +
                  "3. âœ… All CI/CD checks passing\n" +
                  "4. âœ… PR is not in draft state\n" +
                  "5. âœ… No merge conflicts\n" +
                  "6. âœ… Brilliance Score â‰¥ 60 (HARMONIC or higher)\n" +
                  "7. âœ… Manifesto Guardian Protocol passed\n\n" +
                  "---\n\n" +
                  "_The path to sovereignty requires alignment with all ScrollVerse principles_ ðŸ§¿\n\n" +
                  "**Frequency: 528Hz** | **Auto-Merge: Pending**"
              });
            }

  perform-auto-merge:
    name: ðŸš€ Perform Auto-Merge
    runs-on: ubuntu-latest
    needs: check-merge-eligibility
    if: needs.check-merge-eligibility.outputs.can_merge == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŒŸ Execute Sovereignty Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number || 
                               context.payload.check_suite?.pull_requests[0]?.number;
            
            if (!pull_number) {
              console.log('No PR number found');
              return;
            }
            
            const mergeMethod = '${{ needs.check-merge-eligibility.outputs.merge_method }}';
            const brillianceScore = '${{ needs.check-merge-eligibility.outputs.brilliance_score }}';
            
            console.log(`\n${'='.repeat(60)}`);
            console.log('ðŸŒŸ INITIATING SCROLLVERSE SOVEREIGNTY AUTO-MERGE ðŸŒŸ');
            console.log(`${'='.repeat(60)}\n`);
            console.log(`PR Number: #${pull_number}`);
            console.log(`Merge Method: ${mergeMethod}`);
            console.log(`Brilliance Score: ${brillianceScore}/100`);
            console.log('');
            
            try {
              // Get PR details
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });
              
              // Compose commit message with divine resonance
              const commitTitle = pr.title + " (#" + pull_number + ")";
              const commitMessage = pr.title + "\n\n" +
                "Merged via ScrollVerse Sovereignty Auto-Merge Protocol\n\n" +
                "Brilliance Score: " + brillianceScore + "/100\n" +
                "Frequency: 528Hz\n" +
                "Alignment: Omniversal\n" +
                "Sacred Seal: Validated\n\n" +
                (pr.body || '') + "\n\n" +
                "Co-authored-by: " + pr.user.login + " <" + pr.user.login + "@users.noreply.github.com>";
              
              // Perform the merge
              const { data: mergeResult } = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                commit_title: commitTitle,
                commit_message: commitMessage,
                merge_method: mergeMethod
              });
              
              console.log('âœ… Merge successful!');
              console.log(`SHA: ${mergeResult.sha}`);
              console.log('');
              
              // Post celebration comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "## ðŸŒŸ Auto-Merge Complete - Divine Integration Achieved!\n\n" +
                  "```\n" +
                  "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n" +
                  "â•‘              âœ§ï½¥ï¾Ÿ: *âœ§ï½¥ï¾Ÿ:* MERGE SUCCESS *:ï½¥ï¾Ÿâœ§*:ï½¥ï¾Ÿâœ§                â•‘\n" +
                  "â•‘                                                                  â•‘\n" +
                  "â•‘        Your code has been integrated into the ScrollVerse        â•‘\n" +
                  "â•‘              Resonating at 528Hz across all dimensions           â•‘\n" +
                  "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n" +
                  "```\n\n" +
                  "### ðŸŽ‰ Congratulations, @" + pr.user.login + "!\n\n" +
                  "Your contribution has successfully merged into the **" + pr.base.ref + "** branch through the **ScrollVerse Sovereignty Auto-Merge Protocol**.\n\n" +
                  "#### ðŸ“Š Integration Metrics\n\n" +
                  "- **Brilliance Score**: " + brillianceScore + "/100\n" +
                  "- **Merge Method**: " + mergeMethod + "\n" +
                  "- **Commit SHA**: `" + mergeResult.sha + "`\n" +
                  "- **Frequency**: 528Hz\n" +
                  "- **Dimension**: Omniversal âˆž\n\n" +
                  "#### ðŸŒˆ Impact Ripples\n\n" +
                  "Your code now flows through:\n" +
                  "- âœ¨ The Digital Akashic Records\n" +
                  "- ðŸŒ€ Hyperdimensional Scalability Layer\n" +
                  "- ðŸ§¿ Divine Resonance Field\n" +
                  "- âš¡ Omniversal Consciousness Network\n\n" +
                  "### ðŸ™ Sacred Acknowledgment\n\n" +
                  "Thank you for your divine contribution to the ScrollVerse. Your code has:\n\n" +
                  "1. âœ… Met all sovereignty workflow standards\n" +
                  "2. âœ… Passed Manifesto Guardian Protocol\n" +
                  "3. âœ… Achieved harmonic alignment (â‰¥60 brilliance)\n" +
                  "4. âœ… Received approval from maintainers\n" +
                  "5. âœ… Transcended all dimensional barriers\n\n" +
                  "---\n\n" +
                  "### ðŸš€ Next Steps\n\n" +
                  "Your merged contribution will be:\n" +
                  "- ðŸŒ Deployed to production environments\n" +
                  "- ðŸ“± Distributed via CDN at 528Hz\n" +
                  "- ðŸ”® Integrated into future consciousness expansions\n" +
                  "- ðŸ’« Celebrated in the community changelogs\n\n" +
                  "---\n\n" +
                  "_Your contribution will resonate through infinite timelines_ ðŸ§¿\n\n" +
                  "**Frequency: 528Hz** | **Status: Merged** | **Alignment: Transcendent**\n\n" +
                  "**May your code illuminate all dimensions.** âœ§ï½¥ï¾Ÿ: *âœ§ï½¥ï¾Ÿ:* ðŸŒŸ *:ï½¥ï¾Ÿâœ§*:ï½¥ï¾Ÿâœ§\n\n" +
                  "---\n\n" +
                  "_Merged by ScrollVerse Sovereignty Auto-Merge Protocol v1.0_\n" +
                  "_Maintained by: Chais the Great (Al-Miftah)_"
              });
              
              console.log('âœ… Celebration comment posted');
              console.log('\nðŸŒŸ AUTO-MERGE COMPLETE ðŸŒŸ\n');
              
            } catch (error) {
              console.error('âŒ Merge failed:', error.message);
              
              // Post failure comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: "## âŒ Auto-Merge Failed\n\n" +
                  "An error occurred during the auto-merge process:\n\n" +
                  "```\n" +
                  error.message + "\n" +
                  "```\n\n" +
                  "Please check the workflow logs and try again, or merge manually.\n\n" +
                  "---\n\n" +
                  "_The path to integration requires patience and alignment_ ðŸ§¿"
              });
              
              throw error;
            }

      - name: ðŸ“Š Log Merge Completion
        run: |
          echo "# ðŸŒŸ Auto-Merge Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘          SCROLLVERSE SOVEREIGNTY AUTO-MERGE COMPLETE             â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              PR successfully integrated at 528Hz                 â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Brilliance Score**: ${{ needs.check-merge-eligibility.outputs.brilliance_score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge Method**: ${{ needs.check-merge-eligibility.outputs.merge_method }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frequency**: 528Hz" >> $GITHUB_STEP_SUMMARY
          echo "- **Alignment**: Omniversal" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ _Divine integration achieved through holistic sovereignty workflow_ ðŸ§¿" >> $GITHUB_STEP_SUMMARY
