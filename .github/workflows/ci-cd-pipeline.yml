name: âš¡ CI/CD Pipeline

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  setup:
    name: Setup & Environment Check
    runs-on: ubuntu-latest
    outputs:
      has_package_json: ${{ steps.check.outputs.has_package }}
      cache_key: ${{ steps.cache.outputs.key }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ” Check project structure
        id: check
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Cache key generation
        id: cache
        run: |
          if [ -f "package-lock.json" ]; then
            echo "key=node-modules-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT
          else
            echo "key=node-modules-static" >> $GITHUB_OUTPUT
          fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ¨ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        if: needs.setup.outputs.has_package_json == 'true'

      - name: ğŸ“¦ Install dependencies
        run: npm ci
        if: needs.setup.outputs.has_package_json == 'true'

      - name: ğŸ” Check file structure
        run: |
          echo "ğŸ“ Repository structure:"
          tree -L 2 -I 'node_modules|.git' || ls -R
          
      - name: ğŸ“ Count lines of code
        run: |
          echo "ğŸ“Š Code Statistics:"
          echo "HTML files: $(find . -name '*.html' ! -path './node_modules/*' | wc -l)"
          echo "CSS files: $(find . -name '*.css' ! -path './node_modules/*' | wc -l)"
          echo "JS files: $(find . -name '*.js' ! -path './node_modules/*' | wc -l)"
          echo "MD files: $(find . -name '*.md' ! -path './node_modules/*' | wc -l)"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ”’ Run security audit
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level=moderate || echo "âš ï¸ Security audit found issues"
          else
            echo "No package.json, skipping npm audit"
          fi

      - name: ğŸ” Check for exposed secrets
        run: |
          echo "ğŸ” Checking for exposed secrets..."
          
          # Check for common secret patterns
          if grep -r "api[_-]key\s*=\s*['\"][^'\"]*['\"]" . --include="*.js" --include="*.html"; then
            echo "âš ï¸  Potential API key found"
          fi
          
          if grep -r "password\s*=\s*['\"][^'\"]*['\"]" . --include="*.js" --include="*.html"; then
            echo "âš ï¸  Potential password found"
          fi
          
          echo "âœ… Secret scan complete"

  accessibility-check:
    name: Accessibility Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: â™¿ Check accessibility standards
        run: |
          echo "â™¿ Checking HTML accessibility..."
          
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              
              # Check for alt attributes on images
              if grep -q "<img" "$file"; then
                if grep -q 'alt=' "$file"; then
                  echo "  âœ… Alt attributes found"
                else
                  echo "  âš ï¸  No alt attributes found"
                fi
              fi
              
              # Check for semantic HTML
              if grep -qE "<(header|nav|main|article|section|footer)" "$file"; then
                echo "  âœ… Semantic HTML elements found"
              fi
              
              # Check for ARIA labels
              if grep -q "aria-" "$file"; then
                echo "  âœ… ARIA attributes found"
              fi
            fi
          done

  performance-check:
    name: Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš¡ Analyze performance patterns
        run: |
          echo "âš¡ Analyzing performance patterns..."
          
          # Check for 528Hz timing optimization
          if grep -r "duration.*528\|period.*528" *.html; then
            echo "âœ… 528Hz timing patterns found"
          fi
          
          # Check for animation optimization
          if grep -r "will-change\|transform: translate3d" *.html; then
            echo "âœ… Hardware acceleration optimizations found"
          fi
          
          # Check for lazy loading
          if grep -r "loading=\"lazy\"" *.html; then
            echo "âœ… Lazy loading implemented"
          fi

  divine-alignment-check:
    name: Divine Alignment Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ§¿ Validate divine principles
        run: |
          echo "ğŸ§¿ Validating divine alignment..."
          
          # Check for sacred symbols
          symbols=("ğŸ§¿" "âˆ" "âœ§" "ğŸŒ€" "âš¡" "ğŸ•‰")
          found=0
          for symbol in "${symbols[@]}"; do
            if grep -r "$symbol" *.md *.html 2>/dev/null; then
              echo "âœ… Sacred symbol $symbol found"
              found=$((found + 1))
            fi
          done
          
          if [ $found -ge 3 ]; then
            echo "âœ¨ Divine symbolism properly integrated"
          fi
          
          # Check for consciousness-first comments
          if grep -ri "consciousness\|divine\|sacred\|resonance" *.html *.js 2>/dev/null; then
            echo "âœ… Consciousness-first principles present"
          fi

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [setup, code-quality]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸ¨ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ—ï¸ Build project
        run: |
          if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
            npm install
            npm run build
            echo "âœ… Build successful"
          else
            echo "â„¹ï¸  No build step required for static site"
          fi

      - name: ğŸ§ª Run tests
        run: |
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test
            echo "âœ… Tests passed"
          else
            echo "â„¹ï¸  No tests configured"
          fi

  integration-summary:
    name: Integration Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, accessibility-check, performance-check, divine-alignment-check, build-test]
    if: always()
    steps:
      - name: ğŸ“Š Generate CI/CD summary
        run: |
          echo "# âš¡ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              âœ§ï½¥ï¾Ÿ: *âœ§ï½¥ï¾Ÿ:* PIPELINE STATUS *:ï½¥ï¾Ÿâœ§*:ï½¥ï¾Ÿâœ§              â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- â™¿ Accessibility: ${{ needs.accessibility-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Performance: ${{ needs.performance-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§¿ Divine Alignment: ${{ needs.divine-alignment-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ Build & Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resonance Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ _All systems resonating at 528Hz_ ğŸ§¿" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_May your code transcend all dimensions_ âˆ" >> $GITHUB_STEP_SUMMARY
