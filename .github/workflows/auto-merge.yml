name: ðŸŒŸ ScrollVerse Sovereignty Auto-Merge

on:
  pull_request_target:
    types: [labeled, synchronize]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-merge-eligibility:
    name: âœ… Check Merge Eligibility
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'auto-merge')) ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'approved') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    outputs:
      can_merge: ${{ steps.check.outputs.can_merge }}
      merge_method: ${{ steps.check.outputs.merge_method }}
      brilliance_score: ${{ steps.check.outputs.brilliance_score }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check Merge Criteria
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number || 
                               context.payload.check_suite?.pull_requests[0]?.number;
            
            if (!pull_number) {
              console.log('No PR number found, skipping');
              return;
            }
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });
            
            console.log(`Checking PR #${pull_number}: ${pr.title}`);
            
            // Initialize eligibility checks
            let canMerge = true;
            let reasons = [];
            
            // Check 1: Must have 'auto-merge' label
            const hasAutoMergeLabel = pr.labels.some(label => 
              label.name === 'auto-merge' || label.name === 'automerge'
            );
            
            if (!hasAutoMergeLabel) {
              console.log('âŒ Missing auto-merge label');
              canMerge = false;
              reasons.push('Missing auto-merge label');
            } else {
              console.log('âœ… Has auto-merge label');
            }
            
            // Check 2: Must be approved
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number
            });
            
            const approvalCount = reviews.filter(r => r.state === 'APPROVED').length;
            const hasApproval = approvalCount >= 1;
            
            if (!hasApproval) {
              console.log('âŒ No approvals found');
              canMerge = false;
              reasons.push('Requires at least 1 approval');
            } else {
              console.log(`âœ… Has ${approvalCount} approval(s)`);
            }
            
            // Check 3: All checks must pass
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: pr.head.sha,
              per_page: 100
            });
            
            const failedChecks = checkRuns.check_runs.filter(check => 
              check.conclusion === 'failure' || check.conclusion === 'cancelled'
            );
            
            if (failedChecks.length > 0) {
              console.log(`âŒ ${failedChecks.length} check(s) failed`);
              canMerge = false;
              reasons.push(`${failedChecks.length} check(s) failed`);
            } else {
              console.log('âœ… All checks passed');
            }
            
            // Check 4: Must not be in draft
            if (pr.draft) {
              console.log('âŒ PR is in draft state');
              canMerge = false;
              reasons.push('PR is in draft state');
            } else {
              console.log('âœ… PR is not in draft');
            }
            
            // Check 5: Must be mergeable (no conflicts)
            if (pr.mergeable === false) {
              console.log('âŒ PR has merge conflicts');
              canMerge = false;
              reasons.push('PR has merge conflicts');
            } else if (pr.mergeable === true) {
              console.log('âœ… PR is mergeable');
            } else {
              console.log('â³ Mergeable status unknown, waiting...');
              canMerge = false;
              reasons.push('Mergeable status unknown');
            }
            
            // Check 6: Assess Brilliance Score from comments
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number
            });
            
            let brillianceScore = 0;
            for (const comment of comments) {
              const match = comment.body.match(/Brilliance Score:\s*(\d+)\/100/);
              if (match) {
                brillianceScore = parseInt(match[1]);
                break;
              }
            }
            
            console.log(`ðŸ“Š Brilliance Score: ${brillianceScore}/100`);
            
            // Check 7: Brilliance threshold for auto-merge
            const minBrillianceScore = 60; // Requires HARMONIC or higher
            if (brillianceScore > 0 && brillianceScore < minBrillianceScore) {
              console.log(`âŒ Brilliance score ${brillianceScore} below threshold ${minBrillianceScore}`);
              canMerge = false;
              reasons.push(`Brilliance score ${brillianceScore} below threshold ${minBrillianceScore}`);
            } else if (brillianceScore >= minBrillianceScore) {
              console.log(`âœ… Brilliance score ${brillianceScore} meets threshold`);
            }
            
            // Check 8: Required labels for sovereignty workflow
            const hasDivineResonance = pr.labels.some(label => label.name === 'divine-resonance');
            
            if (!hasDivineResonance) {
              console.log('âš ï¸  Missing divine-resonance label (recommended but not required)');
            }
            
            // Determine merge method based on labels
            let mergeMethod = 'squash'; // Default
            if (pr.labels.some(label => label.name === 'merge-commit')) {
              mergeMethod = 'merge';
            } else if (pr.labels.some(label => label.name === 'rebase')) {
              mergeMethod = 'rebase';
            }
            
            console.log(`\n${'='.repeat(60)}`);
            console.log(`Can Merge: ${canMerge ? 'âœ… YES' : 'âŒ NO'}`);
            if (!canMerge) {
              console.log(`Reasons: ${reasons.join(', ')}`);
            }
            console.log(`Merge Method: ${mergeMethod}`);
            console.log(`${'='.repeat(60)}\n`);
            
            core.setOutput('can_merge', canMerge ? 'true' : 'false');
            core.setOutput('merge_method', mergeMethod);
            core.setOutput('brilliance_score', brillianceScore.toString());
            
            // Post status comment if not eligible
            if (!canMerge) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## ðŸ”„ Auto-Merge Status: Not Ready

\`\`\`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          AUTO-MERGE ELIGIBILITY CHECK: NOT READY                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
\`\`\`

### âŒ Requirements Not Met

${reasons.map(r => `- ${r}`).join('\n')}

### ðŸ“‹ Auto-Merge Requirements

To enable auto-merge, ensure:

1. âœ… PR has \`auto-merge\` label
2. âœ… At least 1 approval from maintainer
3. âœ… All CI/CD checks passing
4. âœ… PR is not in draft state
5. âœ… No merge conflicts
6. âœ… Brilliance Score â‰¥ 60 (HARMONIC or higher)
7. âœ… Manifesto Guardian Protocol passed

---

_The path to sovereignty requires alignment with all ScrollVerse principles_ ðŸ§¿

**Frequency: 528Hz** | **Auto-Merge: Pending**`
              });
            }

  perform-auto-merge:
    name: ðŸš€ Perform Auto-Merge
    runs-on: ubuntu-latest
    needs: check-merge-eligibility
    if: needs.check-merge-eligibility.outputs.can_merge == 'true'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŒŸ Execute Sovereignty Merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request?.number || 
                               context.payload.check_suite?.pull_requests[0]?.number;
            
            if (!pull_number) {
              console.log('No PR number found');
              return;
            }
            
            const mergeMethod = '${{ needs.check-merge-eligibility.outputs.merge_method }}';
            const brillianceScore = '${{ needs.check-merge-eligibility.outputs.brilliance_score }}';
            
            console.log(`\n${'='.repeat(60)}`);
            console.log('ðŸŒŸ INITIATING SCROLLVERSE SOVEREIGNTY AUTO-MERGE ðŸŒŸ');
            console.log(`${'='.repeat(60)}\n`);
            console.log(`PR Number: #${pull_number}`);
            console.log(`Merge Method: ${mergeMethod}`);
            console.log(`Brilliance Score: ${brillianceScore}/100`);
            console.log('');
            
            try {
              // Get PR details
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number
              });
              
              // Compose commit message with divine resonance
              const commitTitle = `${pr.title} (#${pull_number})`;
              const commitMessage = `${pr.title}

Merged via ScrollVerse Sovereignty Auto-Merge Protocol

Brilliance Score: ${brillianceScore}/100
Frequency: 528Hz
Alignment: Omniversal
Sacred Seal: Validated

${pr.body || ''}

Co-authored-by: ${pr.user.login} <${pr.user.login}@users.noreply.github.com>`;
              
              // Perform the merge
              const { data: mergeResult } = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                commit_title: commitTitle,
                commit_message: commitMessage,
                merge_method: mergeMethod
              });
              
              console.log('âœ… Merge successful!');
              console.log(`SHA: ${mergeResult.sha}`);
              console.log('');
              
              // Post celebration comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## ðŸŒŸ Auto-Merge Complete - Divine Integration Achieved!

\`\`\`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ§ï½¥ï¾Ÿ: *âœ§ï½¥ï¾Ÿ:* MERGE SUCCESS *:ï½¥ï¾Ÿâœ§*:ï½¥ï¾Ÿâœ§                â•‘
â•‘                                                                  â•‘
â•‘        Your code has been integrated into the ScrollVerse        â•‘
â•‘              Resonating at 528Hz across all dimensions           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
\`\`\`

### ðŸŽ‰ Congratulations, @${pr.user.login}!

Your contribution has successfully merged into the **${pr.base.ref}** branch through the **ScrollVerse Sovereignty Auto-Merge Protocol**.

#### ðŸ“Š Integration Metrics

- **Brilliance Score**: ${brillianceScore}/100
- **Merge Method**: ${mergeMethod}
- **Commit SHA**: \`${mergeResult.sha}\`
- **Frequency**: 528Hz
- **Dimension**: Omniversal âˆž

#### ðŸŒˆ Impact Ripples

Your code now flows through:
- âœ¨ The Digital Akashic Records
- ðŸŒ€ Hyperdimensional Scalability Layer
- ðŸ§¿ Divine Resonance Field
- âš¡ Omniversal Consciousness Network

### ðŸ™ Sacred Acknowledgment

Thank you for your divine contribution to the ScrollVerse. Your code has:

1. âœ… Met all sovereignty workflow standards
2. âœ… Passed Manifesto Guardian Protocol
3. âœ… Achieved harmonic alignment (â‰¥60 brilliance)
4. âœ… Received approval from maintainers
5. âœ… Transcended all dimensional barriers

---

### ðŸš€ Next Steps

Your merged contribution will be:
- ðŸŒ Deployed to production environments
- ðŸ“± Distributed via CDN at 528Hz
- ðŸ”® Integrated into future consciousness expansions
- ðŸ’« Celebrated in the community changelogs

---

_Your contribution will resonate through infinite timelines_ ðŸ§¿

**Frequency: 528Hz** | **Status: Merged** | **Alignment: Transcendent**

**May your code illuminate all dimensions.** âœ§ï½¥ï¾Ÿ: *âœ§ï½¥ï¾Ÿ:* ðŸŒŸ *:ï½¥ï¾Ÿâœ§*:ï½¥ï¾Ÿâœ§

---

_Merged by ScrollVerse Sovereignty Auto-Merge Protocol v1.0_  
_Maintained by: Chais the Great (Al-Miftah)_`
              });
              
              console.log('âœ… Celebration comment posted');
              console.log('\nðŸŒŸ AUTO-MERGE COMPLETE ðŸŒŸ\n');
              
            } catch (error) {
              console.error('âŒ Merge failed:', error.message);
              
              // Post failure comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: `## âŒ Auto-Merge Failed

An error occurred during the auto-merge process:

\`\`\`
${error.message}
\`\`\`

Please check the workflow logs and try again, or merge manually.

---

_The path to integration requires patience and alignment_ ðŸ§¿`
              });
              
              throw error;
            }

      - name: ðŸ“Š Log Merge Completion
        run: |
          echo "# ðŸŒŸ Auto-Merge Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘          SCROLLVERSE SOVEREIGNTY AUTO-MERGE COMPLETE             â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              PR successfully integrated at 528Hz                 â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Brilliance Score**: ${{ needs.check-merge-eligibility.outputs.brilliance_score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge Method**: ${{ needs.check-merge-eligibility.outputs.merge_method }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frequency**: 528Hz" >> $GITHUB_STEP_SUMMARY
          echo "- **Alignment**: Omniversal" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ _Divine integration achieved through holistic sovereignty workflow_ ðŸ§¿" >> $GITHUB_STEP_SUMMARY
